---
title:  "网站渗透与防护"
layout: post
tags: 信息安全 web
---

虽然你可能自作多情地认为你的网站很重要，但事实上绝大多数网站对于攻击者来说都是低价值的，人家只是想借用你的网站作为其中一个小据点以便实行更大的计划。对于这些低价值网站，攻击者一般不会费力进行针对性的攻击，相反攻击者用自动化的漏洞扫描器在整个互联网中寻找脆弱的网站以求入侵尽可能多的网站，所以只要还有相当数量的其它网站比你的更脆弱，经济学原则就能保障你的网站成为入侵目标的风险可控。因此，防范最常见的漏洞是性价比最高的。

## 常见漏洞

以下讲解2017年OWASP排名前十的风险因素，由最危险的开始。

### 注入

属性|说明
---|---
攻击向量|以参数、头、请求体、响应体、环境变量或任何其它数据源为载体的恶意数据
安全弱点|不可信数据能被意外地当作代码（SQL、ORM、shell、PHP、LDAP、XML、JSON、XPath、SMTP、表达式语言等等）让解释器执行
影响|直接后果为数据丢失、破坏或泄露，进而可能引致拒绝服务甚至主机被完全接管，同时破坏审计
检测方法|代码审查、静态分析
预防方法|验证或净化数据、参数化调用

作为一个例子，假如一个拙劣的登录服务可能有PHP代码形如`$user=odbc_exec($conn,"SELECT * FROM users WHERE USER='$_POST[username]' AND PASSWORD='$_POST[password]'")`以便根据结果集是否空来判断用户名与密码是否配对，如果用户提交表单中的`username`参数为`admin'--`则只要有这个用户名，无论参数`password`填什么都能成功登录，因为实际执行的SQL代码变成`SELECT * FROM users WHERE USER='admin'--' AND PASSWORD='anything'`，但`--`是行末注释的开首，故上述SQL代码相当于`SELECT * FROM users WHERE USER='admin'`。

通过使用合适的静态分析工具可以找出有常见的注入漏洞，值得把这类加入你的持续集成过程中，以便在每次部署前及时看到报告并修复有关漏洞。

要预防注入攻击，可以采取以下方法：
- 验证所有外部输入并拒绝处理可疑的，例如在上例中拒绝处理含有单引号或其它能导致字符串提前结束特殊字符的输入。如果插入数据的主键来自用户时还要提防意外同名覆盖的问题。注意，验证必须在服务器端做，任何设在客户端的检查（如基于Javascript的或`input`元素约束的）都不能算数，因为他们能轻易地被绕过，攻击者能用他们想要的参数、cookies和请求体直接构造请求，完全绕过浏览器。
- 净化数据后再继续处理，例如在上例中先把所有`'`转义为`''`，这样就能接受所有输入。然而，必须完全清楚解释器语言的词法才能正确地转义所有可疑字符，不能有漏网之鱼，而且语言可能随版本升级而变更。
- 使用类型安全参数化API代替解释器调用，例如上例中改用预编译的语句模板`$stmt=odbc_prepare($conn,'SELECT * FROM users WHERE USER=? AND PASSWORD=?');$user=odbc_execute($stmt,array($_POST[username],$_POST[password]));`，从而把数据与代码隔离。

无论从安全性、性能还是编码风格考虑，都强烈推荐最后一个方法。


### 失效的身份认证 

属性|说明
---|---
攻击向量|用户名和密码
安全弱点|弱密码、密码暴露
影响|别人得以冒充获授权者取得可用于洗钱、欺诈等行为的服务或敏感数据，攻破管理员帐户更可能可完全接管主机
检测方法|审计失败的登录尝试
预防方法|强密码、限制重试、多因素认证、会话超时

- 破解密码
    - 暴力破解。当可选的密码总数太少时（比如四位数字组成的密码也就一万个），攻击者可以通过尝试所有可能的密码来找到正确的密码。有的界面设计会使猜测更快，比如说如果输入不是真正密码前缀时立即提示密码错误会大幅减少要暴力尝试的次数（破解机械密码锁就是这原理），提示“密码错误”则暗示了用户名存在。
    - 字典攻击。由于许多人都在使用少数易记的密码，攻击者尝试这些密码就好了，毕竟他们通常没有特定目标，随意攻入一些帐号就足够了（比如用来下载会员资源）。
    - 撞库。由于许多人在多个网站使用相同的用户名和密码，当一个网站的帐号被破解后攻击者可能尝试用相同帐号登录其它网站。
    - 默认密码。一些服务器端软件如内容管理系统安装时默认创建相同的管理员帐号，管理员又往往没有及时修改，这时管理后台就很容易被控制。
    - 搜索。人们可能不小心把帐号无意泄露到网上，例如把带API密钥的服务器配置文件推入到公开的代码仓库，在搜索引擎
    - 社会工程。攻击者可能制作仿冒的钓鱼网站，引诱用户输入用户名和密码。
    - 密码保存。浏览器和其它软件可能保存密码（而且保存的方式往往不太安全，不然恢复不了），这样如果其它人使用同一机器就可以冒充。
    - 网络窃听。如果客户端与服务器间的通信没有适当鉴别和加密，明文传输的密码可能被窃听。
- 破解其它凭证。值得注意的是，许多网站同时使用密码外的身份凭证，如果这些凭证比密码更脆弱，则会成为攻击点。
    - 脆弱的找回密码机制。有的网站容许用户通过注册时设置的密保问题找回密码，但密保问题（比如“你的母亲哪年出生”）的可能答案太少，很容易猜到。
    - 会话。很多网站在用户登录后便用URL参数或Cookies来识别，用户在公共计算机上登录过后其它用户可以继续使用。
    - 生物特征。取得别人的指纹图像、虹膜图像、人脸图像、声音录音并不困难。

要巩固身份验证和会话管理，可以采取以下方法：


- 绝不使用固定的默认密码，并禁止设置弱密码，包括太短或太常见的。对于安全性要求较高的场合，使用自动随机生成的长密码。
- 登录时要求输入验证码，由此限制自动暴力破解成功的可能性，同时记录失败的登录以便审计。不过不建议硬性限制重试密码的频率或次数，因为这可能引入拒绝服务攻击漏洞，例如攻击者只要疯狂重试密码就能冻结大量帐号使合法用户也登录不了。
- 在安全性要求较高的场合使用多因素认证，例如短信验证码或数字证书。多因素应该尽可能相互独立，否则只会形成虚假的安全感并降低用户体验。
- 随机生成足够复杂的会话标识，并在一段时间不活跃后自动注销，同时检测和阻止同一会话标识被多个客户端使用。
- 不要把会话标识作为URL中参数，因为用户可能在分享页面时无意泄露。

### 敏感数据泄露 

属性|说明
---|---
攻击向量|没有适当鉴别和加密的数据
安全弱点|弱加密算法、弱密钥生成及管理协议和弱密码
影响|泄露隐私信息如财务和医疗，还可能使身份认证失效
检测方法|
预防方法|访问控制、通信加密、存储加密、密码加盐哈希

为了防范客户端和服务器端的恶意软件，还有中间人攻击：

- 全站强制SSL，采用现代标准的算法、密钥和协议
- 加密含有敏感数据的文件
- 尽可能不保存敏感信息，如绝不保存用户密码的明文，加密也不行，只能保存哈希值（使用类似bCrypt的哈希算法，轮数设计到约一秒才能完成计算）。加盐哈希（如把密码接上用户名再哈希）更佳，因为可防范彩虹表（常见密码对应的哈希值表0）。
- 访问控制，按敏感程序对数据分级并分别制订访问规则，例如不能让普通用户下载到密码哈希文件来离线破解
- 避免缓存敏感数据，因为缓存可能导致绕过检查的访问

### XML 外部实体(XXE) 

属性|说明
---|---
攻击向量|上传恶意XML文档
安全弱点|有缺陷的XML处理器
影响|窃取文件、监听内部端口、执行远程服务器请求和实施拒绝服务攻击
检测方法|依赖项检测
预防方法|禁用XML外部实体处理，改用更简单格式

许多早期或配置错误的XML处理器会把XML文件中的外部实体引用替换为目标的内容，这可能使得XML处理器意外地访问危险的URL。比如说以下代码可能导致泄露系统用户信息（如果XML处理器有访问权限）：

```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
<foo>&xxe;</foo>
```

通过修改上面的实体声明可以访问其它URL并导致严重后果：
- 改为`<!ENTITY xxe SYSTEM "file:///dev/random" >`会使XML处理器企图读取一个无穷长的文件，从而无响应甚至耗尽内存和交换空间，形成拒绝服务攻击
- 改为`<!ENTITY xxe SYSTEM "https://192.168.1.1/private" >`则可以访问内部网络，进行端口扫描甚至通过调用内部Restful服务的API破坏数据。

防范方法有：
- 避免解析外部提供的XML文件或片段，例如改用更简单的JSON格式
- 对外部输入进行验证和基于白名单的净化
- 使用更新的XML处理器，可以的话禁用XML外部实体甚至DTD处理

### 失效的访问控制 

属性|说明
---|---
攻击向量|“秘密”URL
安全弱点|作URL看作访问凭证
影响|功能和数据的未授权访问，冒充用户甚至管理员
检测方法|代码审查、静态分析、漏洞扫描
预防方法|正确实现访问控制

一些网站自以为做了访问控制，但由于拙劣的实现而能够轻易被绕过。这种情况类似于在地铁闸口设安检却容许人家在旁边往闸内区域递物件，这种虚假的安全感是有害的。最常见的错觉是以为只有你告知的人才知道URL，然后把访问该“秘密”URL的人都视为是有授权的。现实是URL很容易泄漏：
- 许多网站都使用一些常见的文件名，例如`admin.php`作为管理后台
- URL结构暴露内部实现（`robots.txt`就可能弄巧反拙），例如用参数`file`表示下载文件的路径，更糟糕的是攻击可能用带`../`的路径访问意外的目录
- 用户可能分享URL给其它人，例如把会员资源的URL放到社交平台上推荐给其它人，同时把作为会话ID的参数也暴露了，于是非会员也看了
- 无意中公开了网站源码或网站目录，例如放到公开的代码仓库（包括暴露`.git`目录之类）或会显示文件列表的Web服务器

防范方法是正确实现访问控制：
- 最好直接使用经得起时间验证的现有访问控制框架而不是自己设计
- 对所有会返回敏感数据或修改持久化数据的请求强制执行认证，特别是HTTP请求如POST、PUT和DELETE
- 多用一次性URL，它们被访问一次或超过一段时间没有被访问就即时失效，从而防止重放攻击
- 用户注销后立即使会话ID失效
- 限制使用跨源资源（CORS）以减低用户成为XSS受害者的机会
- 禁用 Web服务器目录列表并确保元数据没有在其它地方泄漏
- 限制访问速率以提高自动猜测网站结构所需时间
- 保留所有访问日志以便审查

### 安全配置错误 

属性|说明
---|---
攻击向量|未修复的漏洞、默认账户、不再使用的页面、未受保护的文件
安全弱点|网络服务、平台、Web服务器、应用服务器、数据库、框架、自定义代码、虚拟机、容器和存储的不安全配置
影响|未授权的访问或暴露系统信息
检测方法|配置扫描
预防方法|安装安全更新、可重复的配置管理

以下是一些常见的安全错误：
您的应用程序可能受到攻击,如果应用程序是: 应实施安全的安装过程,包括:
- 应用程序栈堆的任何部分都缺少适当的安全加固甚至已过时
- 应用程序启用或安装了不必要的功能，例如不必要的功能、组件、文档、示例、端口、服务、网页、帐户或权限
- 默认帐户的密码仍然可用且没有更改
- 错误处理机制向用户披露堆栈跟踪或其他过于详细的错误信息

为了良好地配置系统：
- 搭建最小化平台
- 尽可能隔离组件（如用不同用户运行）并仅给予它们所需的最低权限
- 建立自动化的配置脚本以确保测试环境和部署环境有相同的安全性，在每个环境中使用不同的密码
- 仔细检查和修复安全配置项来适应最新的安全说明、更新和补丁


### 跨站脚本(XSS) 

属性|说明
---|---
攻击向量|
安全弱点|应用程序动态生成的网页中包含不受信任的数据
影响|使用户浏览器执行恶意代码，可导致身份盗用、网站内容不能正常显示或重定向到恶意站点
检测方法|代码审查、静态分析、漏洞扫描
预防方法|净化用户上传内容

跨站脚本通过注入HTML和Javascript到动态生成的网页中，与上述注入攻击不同的时，代码被客户端浏览器而非服务器执行。作为一个例子，假设一个讨论区直接把用户提交的评论插入到页面后，则如果用户提交的评论中有`<script>`标签，则其它访问讨论区的用户的浏览器就会执行这些javascript代码。跨站脚本可能进行以下恶意行为：
- 放置广告、链接或图片，消除网页原有内容，或者直接重定向，由此为恶意网站引流、骗取广告费或者对任意网站发动分布式拒绝服务攻击
- 通过DOM访问密码、会话ID、CSRF令牌等敏感信息，从而冒充用户向服务器发送请求

防范XSS的方法仍然是在服务器端净化所有用户提供的输入后才用于生成页面，净化包括移除或转义所有可疑HTML标签。

### 不安全的反序列化 

属性|说明
---|---
攻击向量|序列化对象
安全弱点|没有验证数据的完整性
影响|远程代码执行、重放攻击、注入攻击
检测方法|
预防方法|避免反序列化、完整性检查、类型约束

为了传输或存储对象（例如用于进程间通信、缓存和持久化），往往需要先把对象序列化再写入，然后需要反序列化读取的字节来恢复对象。问题在于开发者经常以为反序列化得到的就是序列化前的合法对象，而没有留意到存储在cookies、请求参数或其它媒体的序列化对象可能被篡改，于是不加检查地使用得到的对象就可能误用被篡改后的数据，这些恶意数据甚至不满足由代码保证的约束条件。更严重的是，对象类型也可能不是原来的，于是调用多态方法时可能执行到意外的代码。

防范方法有：
- 不对不受信源的序列化对象进行反序列化
- 执行完整性检查,如对序列化对象进行数字签名,以防止恶意对象被创建或数据被篡改
- 用白名单限制反序列化所能创建对象的类型
- 隔离在低权限环境运行涉及反序列化的代码
- 记录反序列化失败信息（包括类型非预期）以及早发现被试探

### 使用含有已知漏洞的组件 

属性|说明
---|---
攻击向量|含有已知漏洞的组件
安全弱点|已知漏洞
影响|取决于漏洞的严重性
检测方法|漏洞扫描器
预防方法|补丁、移除非必要组件

组件(例如:库、框架和其他软件模块)通常拥有和应用程序相同的权限。如果应用程序中含有已知漏洞的组件被攻击者利用,可能会造成严重的数据丢失或服务器接管。同时,使用含有已知漏洞的组件的应用程序和API可能会破坏应用程序防御、造成各种攻击并产生严重影响。

以下是一些防护方法：
- 仅从官方渠道获取组件并验证签名
- 移除不使用的依赖、功能、组件、文件和文档
- 自动定期安装安全更新，避免使用已不再维护的软件
- 审查安全相关配置
- 定期进行漏洞扫描

### 不足的日志记录和监控 

属性|说明
---|---
攻击向量|清除入侵痕迹
安全弱点|不足的日志记录及监控
影响|出事了也不知道或查不出原因，从而不能及时应对，导致被入侵常态化
检测方法|尝试从日志还原渗透测试
预防方法|记录所有安全事件、告警机制

- 统一记录所有登录、访问控制、输入验证失败到日志中,并保留足够的上下文信息以识别可疑帐户
- 防止日志被篡改或删除，如把文件设置为只能在末尾添加，并远程备份
- 建立有效的告警机制,使可疑活动发生时自动通知管理员
- 建立可视化仪表盘以便监控网站的近实时运行情况

### 其它漏洞

以下列出紧随其后的几个漏洞类型：

- 跨站点请求伪造(CSRF)
- 不受控制的资源消耗
- 无限制上传危险类型文件
- 用户界面(UI)对关键信息的误传(点击劫持和其他)
- 未经验证的转发和重定向
- 交互频率控制不当(反自动化)
- 不可信控制域包含功能性(第三方内容)
- 服务器端请求伪造(SSRF)

## 工具

### 收集信息

虽然安全性要求高的系统可能要求在敌方完全知道网站体系架构后仍然坚如磐石，但只要你的网站不是重点攻击对象，攻击者不会费力搞清楚你的网站的结构，只会抓住一些很表面的迹象。以下我们说明一些表面的迹象可以如何暴露信息：

首先，我们说明一些不用与目标机器连接就能得到的信息：

- 域名注册信息。`whois 域名`可以获取域名信息：
    - 所有者信息，姓名、地址和邮箱可
    - 注册商信息，寻找脆弱的注册商
    - 到期日
    - 解析服务器
- 域名解析信息。用`host`、`dig`、`nslookup`等命令可以查询域名解析信息，
- 搜索
    - `inurl:admin.php`之类的搜索可以找到许多已知后台入口的网站
- 网页快照快照。一些网站如[Archive](https://archive.org/)和搜索引擎会保存大量网页的快照，由此可了解网站的版本历史，包括安全修正和过去被窜改的情况。

通过与目标机器连接，往往可得到更多信息：
- 端口扫描。通过`nmap -v -A 主机`找出主机各端口尝试连接可找出开放的端口并猜测正在运行的软件，一旦发现它在运行有已知漏洞的软件就可以设法利用。
- 请求常见路径。
    - `favicon.ico`。如果网站图标与常见框架相同，就可估计它在使用该框架，同时像是新站或管理员不负责任，因而后台密码和其它安全设置也可能处于默认状态。
    - `robots.txt`。这文件用于限制搜索引擎的访问，同时往往泄露网站结构，例如后台入口。
    - Wordpress、phpMyAdmin之类的软件的默认后台路径。
- HTTP方法。如果支持不经认证进行`PUT`、`DELETE`之类的危险方法，可能可窜改网站。

git
owasp-wte-burpsuite 1.6-00
owasp-wte-cal9000 2.0-00
owasp-wte-dirbuster 1.0-RC1-00
owasp-wte-ende 1.0RC12-00
owasp-wte-fierce 0.9.11-Beta04162015-00
owasp-wte-fuzzdb 2015-04-26-svn-00
owasp-wte-grendel-scan 1.0-00
owasp-wte-gruyere 1.0-00
owasp-wte-httprint 301-00
owasp-wte-jbrofuzz 2.5-00
owasp-wte-jerry-curl 1.1-00
owasp-wte-jq 1.4-00
owasp-wte-netcat 1.10-00
owasp-wte-nikto 2.1.5-00
owasp-wte-paros 3.2.13-00
owasp-wte-ratproxy 1.58-00
owasp-wte-skipfish 2.10-00
owasp-wte-spikeproxy 1.4.8-00
owasp-wte-sqlbrute 1.0-00
owasp-wte-sqlmap 0-git-5ee7fd785a-00
owasp-wte-tcpdump 4.5.1-00
owasp-wte-w3af 1.1svn5547-00
owasp-wte-wapiti 2.3.0-00
owasp-wte-webgoat 6.0.1-00
owasp-wte-webscarab 20090122-00
owasp-wte-webslayer 0-svn-r5-00
owasp-wte-wireshark 1.10.6-00
owasp-wte-wpscan 0-git-22550ea55-00
owasp-wte-wsfuzzer 1.9.5-00
owasp-wte-wte-docs 20150503-00
owasp-wte-zap 2.4.0-00


## 检查清单

如果希望进一步提升网站安全技能，以下是一些建议：
- 使用[OpenVAS](http://www.openvas.org/)漏洞扫描器以了解其它网站的安全情况。
- 使用[ZAP](https://www.owasp.org/index.php/OWASP_Zed_Attack_Proxy_Project)扫描你的网站以寻找已知漏洞。
- 在虚拟机中运行[OWASP破损Web应用项目](https://www.owasp.org/index.php/OWASP_Broken_Web_Applications_Project)中的各个应用，然后尝试找出其中的安全漏洞并加以利用，由此锻炼渗透测试能力。
